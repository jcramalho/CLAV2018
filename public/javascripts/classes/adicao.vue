var side = new Vue({
    el: '#sidenav',
    data: {
        navComplete: [
            {
                label: "Nível",
                anchor: "#nivel",
                lvl: 1
            },
            {
                label: "Classe Pai",
                anchor: "#pai",
                lvl: 2
            },
            {
                label: "Código",
                anchor: "#codigo",
                lvl: 1
            },
            {
                label: "Título",
                anchor: "#titulo",
                lvl: 1
            },
            {
                label: "Descrição",
                anchor: "#descricao",
                lvl: 1
            },
            {
                label: "Notas de Aplicação",
                anchor: "#notasA",
                lvl: 1
            },
            {
                label: "Exemplos de Notas de Aplicação",
                anchor: "#exemplos",
                lvl: 1
            },
            {
                label: "Notas de Exclusão",
                anchor: "#notasE",
                lvl: 1
            },
            {
                label: "Termos de Índice",
                anchor: "#termosI",
                lvl: 3
            },
            {
                label: "Tipo de Processo",
                anchor: "#tipoTrans",
                lvl: 3
            },
            {
                label: "Processo Tranversal",
                anchor: "#tipTrans",
                lvl: 3
            },
            {
                label: "Donos",
                anchor: "#donos",
                lvl: 3
            },
            {
                label: "Participantes",
                anchor: "#participantes",
                lvl: 3
            },
            {
                label: "Processos Relacionados",
                anchor: "#PNrel",
                lvl: 3
            },
            {
                label: "Legislação",
                anchor: "#legislacao",
                lvl: 3
            },
            {
                label: "PCA",
                anchor: "#PCA",
                lvl: 3
            },
            {
                label: "Destino Final",
                anchor: "#DF",
                lvl: 3
            },
        ],
        nav: []
    },
    methods: {
        changeNav: function (type) {
            this.nav = this.navComplete.filter(
                a => a.lvl <= type
            )
        }
    },
    mounted() {
        this.changeNav(1);
    }
})

var newClass = new Vue({
    el: '#nova-classe-form',
    http: {
        emulateJSON: true,
        emulateHTTP: true
    },
    components: {
        spinner: VueStrap.spinner,
        accordion: VueStrap.accordion,
        panel: VueStrap.panel,
        tabs: VueStrap.tabs,
        tabGroup: VueStrap.tabGroup,
        tab: VueStrap.tab,
        modal: VueStrap.modal,
    },
    data: {
        codeFormats: {
                1: /^[0-9]{3}$/,
                2: /^[0-9]{3}\.[0-9]{2}$/,
                3: /^[0-9]{3}\.[0-9]{2}\.[0-9]{3}$/,
                4: /^[0-9]{3}\.[0-9]{2}\.[0-9]{3}\.[0-9]{3}$/,
        },

        classLevel: 1,

        nEdits: 0,
        
        parent: null,
        parents: null,
        parentsReady: false,

        code: null,

        title: null,

        legsTableHeader: ["#", "Tipo", "Número", "Título", "Data"],
        legsTableWidth: ['5%', '19%', '11%', '50%', '15%'],
        legList: [],
        selectedLegs: [],
        legsReady: false,

        description: null,

        newExAppNote: null,
        exAppNotes: [],

        newAppNote: null,
        appNotes: [],

        newDelNote: null,
        delNotes: [],

        newIndex: null,
        indexes: [],

        status: "H",

        procType: "pc",

        procTrans: "N",

        orgsTableHeader: ["#", "Sigla", "Designacao", "Tipo"],
        orgsTableWidth: ["4%", "15%", "70%", "15%"],
        ownerList: [],
        selectedOwners: [],
        orgsReady: false,

        entidadesTableHeader: ["#", "Sigla", "Designacao", "Tipo"],
        entidadesTableWidth: ["4%", "15%", "70%", "15%"],
        donos: [],
        donosSelecionados: [],
        entidadesReady: false,

        partDic: {
            Apreciador: "Apreciar",
            Assessor: "Assessorar",
            Comunicador: "Comunicar",
            Decisor: "Decidir",
            Executor: "Executar",
            Iniciador: "Iniciar",
        },

        participantLists: {
            Apreciador: [],
            Assessor: [],
            Comunicador: [],
            Decisor: [],
            Iniciador: [],
            Executor: [],
        },
        participantsSelected: {
            Apreciador: [],
            Assessor: [],
            Comunicador: [],
            Decisor: [],
            Executor: [],
            Iniciador: [],
        },
        participantsSelectedInfo: {
            Apreciador: [],
            Assessor: [],
            Comunicador: [],
            Decisor: [],
            Executor: [],
            Iniciador: [],
        },

        relationList: [],
        relationsSelected: [],
        relationTypes: [
            {
                label: 'Antecessor de',
                value: 'eAntecessorDe'
            },
            {
                label: 'Sucessor de',
                value: 'eSucessorDe',
            },
            {
                label: 'Complementar de',
                value: 'eComplementarDe',
            },
            {
                label: 'Cruzado com',
                value: 'eCruzadoCom',
            },
            {
                label: 'Sintese de',
                value: 'eSinteseDe',
            },
            {
                label: 'Sintetizado por',
                value: 'eSintetizadoPor',
            },
            {
                label: 'Suplemento de',
                value: 'eSuplementoDe',
            },
            {
                label: 'Suplemento para',
                value: 'eSuplementoPara',
            }
        ],
        relationsSelectedInfo: [],
        classesReady: false,

        pca: {
            dueDate: null,
            count: { label: "Forma de Contagem", id: null },
            subcount: { label: "Sub-forma de Contagem", id: null },
            criteria: {
                new: {
                    type: { label: "Tipo de Critério", rel: 0 },
                    content: null,
                    pns: [],
                    leg: [],
                },
                classes: [],
                legislation: [],
                pns: {
                    CriterioJustificacaoUtilidadeAdministrativa: [],
                    CriterioJustificacaoComplementaridadeInfo: [],
                },
                types: [
                    {
                        value: "CriterioJustificacaoLegal",
                        label: "Critério Legal",
                        rel: 1
                    },
                    {
                        value: "CriterioJustificacaoUtilidadeAdministrativa",
                        label: "Critério Utilidade Administrativa",
                        rel: 2
                    },
                    {
                        value: "CriterioJustificacaoGestionario",
                        label: "Critério Gestionário",
                        rel: 0
                    },
                ],
                list: []
            }
        },
        countTypes: null,
        subcountTypes: null,
        countsReady: false,
        subcountsReady: false,
        pnsTableHeader: ["#", "Código", "Título"],
        pnsTableWidth: ["4%", "16%", "81%"],

        df: {
            end: null,
            criteria: {
                new: {
                    type: { label: "Tipo de Critério", rel: 0 },
                    content: null,
                    pns: [],
                    leg: [],
                },
                classes: [],
                legislation: [],
                pns: {
                    CriterioJustificacaoDensidadeInfo: [],
                    CriterioJustificacaoComplementaridadeInfo: [],
                },
                types: [
                    {
                        value: "CriterioJustificacaoLegal",
                        label: "Critério Legal",
                        rel: 1
                    },
                    {
                        value: "CriterioJustificacaoDensidadeInfo",
                        label: "Densidade Informacional",
                        rel: 2
                    },
                    {
                        value: "CriterioJustificacaoComplementaridadeInfo",
                        label: "Critério Complementaridade Informacional",
                        rel: 2
                    },
                ],
                list: []
            }
        },

        autoCritIndexes: {
            utilidadeAdmin: -1,         // PCA - criterio de utilidade administrativa (rels: suplementoPara)
            densidadeInfo: -1,          // DF - criterio dansidade informaconal (rels: sinteseDe/sintetizadoPor)
            complementaridadeInfo: -1   // DF - criterio complementaridade informacional (rels: complementar de)
        },

        message: null,
        codeMessage: "",
        parentvalue: "",

        modalMsgShow: false,
        modalMsg: "",
    },
    watch: {
        parentvalue: function () {
            this.parent = this.parentvalue.value;
        },
        parent: function () {
            this.code = this.parent.slice(1, this.parent.length) + ".";
        },
        classLevel: function () {
            this.parent = "";
            if (this.classLevel > 1) {
                this.loadParents();
            }
            if (this.classLevel >= 3 && !this.classesReady) {
                this.loadClasses();
            }
            side.changeNav(this.classLevel);
        },
        code: function () {
            this.codeMessage = "";

            if (this.classLevel > 1) {
                if (this.code.indexOf(this.parent.slice(1, this.parent.length)) != 0) {
                    this.code = this.parent.slice(1, this.parent.length) + ".";
                }
                if (this.code[this.parent.length - 1] != '.') {
                    this.code = this.parent.slice(1, this.parent.length) + ".";
                }
            }

            if (!this.codeFormats[this.classLevel].test(this.code)) {
                this.codeMessage = "Formato inválido";
            }
            else {
                this.checkCodeAvailability(this.code);
            }
        },
        relationsSelected: {
            deep: true,
            handler: function () {
                let pnsCI = []; //complementaridade info - "eComplementarDe"
                let pnsUA = []; //utilidade administrativa - "eSuplementoPara"
                let pnsDI = []; //Densidade informacional - "eSinteseDe" + "eSintetizadoPor"
                let i;

                //complementaridade info
                pnsCI = this.relationsSelected.filter(
                    function (a) {
                        return a.relType == "eComplementarDe";
                    }
                );

                i = 0;
                this.pca.criteria.pns.CriterioJustificacaoComplementaridadeInfo = pnsCI.map(
                    function (a) {
                        return {
                            data: [i++, a.code, a.name],
                            id: a.id,
                            selected: false
                        }
                    }
                );
                this.df.criteria.pns.CriterioJustificacaoComplementaridadeInfo = JSON.parse(JSON.stringify(this.pca.criteria.pns.CriterioJustificacaoComplementaridadeInfo));

                //utilidade administrativa
                pnsUA = this.relationsSelected.filter(
                    function (a) {
                        return a.relType == "eSuplementoPara";
                    }
                );

                i = 0;
                this.pca.criteria.pns.CriterioJustificacaoUtilidadeAdministrativa = pnsUA.map(
                    function (a) {
                        return {
                            data: [i++, a.code, a.name],
                            id: a.id,
                            selected: false
                        }
                    }
                );

                //Densidade informacional
                pnsDI = this.relationsSelected.filter(
                    function (a) {
                        return a.relType == "eSinteseDe" || a.relType == "eSintetizadoPor";
                    }
                );

                i = 0;
                this.df.criteria.pns.CriterioJustificacaoDensidadeInfo = pnsDI.map(
                    function (a) {
                        return {
                            data: [i++, a.code, a.name],
                            id: a.id,
                            selected: false
                        }
                    }
                );
            }
        }
    },
    methods: {
        checkCodeAvailability: _.debounce(
            function (code) {
                this.$http.get('/api/classes/verificar/' + code)
                    .then(response => {
                        if (response.body) {
                            this.codeMessage = "Codigo já existe!";
                        }
                    })
            }, 500
        ),
        relChanged: function (index, rel) {
            if (rel.relType == "eSuplementoPara") {
                if (this.autoCritIndexes.utilidadeAdmin == -1) {
                    let critIndex = -1;

                    //verificar se já existe um critério de utilidade administrativa
                    for (let [i, crit] of this.pca.criteria.list.entries()) {
                        if (crit.type.value == "CriterioJustificacaoUtilidadeAdministrativa") {
                            critIndex = i;

                            break;
                        }
                    }

                    //se não existir criar
                    if (critIndex == -1) {
                        critIndex = this.pca.criteria.list.length;

                        this.addNewJustCrit(this.pca.criteria.list);

                        this.pca.criteria.list[critIndex].type = {
                            value: "CriterioJustificacaoUtilidadeAdministrativa",
                            label: "Critério Utilidade Administrativa",
                            rel: 2
                        };
                    }
                    this.autoCritIndexes.utilidadeAdmin = critIndex;
                }
            }
            else if (rel.relType == "eSinteseDe" || rel.relType == "eSintetizadoPor") {
                if ((rel.relType == "eSinteseDe" && this.checkIfExistsRelation("eSintetizadoPor")) || (rel.relType == "eSintetizadoPor" && this.checkIfExistsRelation("eSinteseDe"))) {
                    this.showMsg("Não podem existir ao mesmo tempo as relações 'Síntese De' e 'Sintetizado Por'!");
                }
                else if (rel.relType == "eSintetizadoPor" && this.checkIfExistsRelation("eComplementarDe")) {
                    this.showMsg("Não podem existir ao mesmo tempo as relações 'Sintetizado Por' e 'Complementar De'!");
                }
                else {
                    this.df.end = (rel.relType == "eSinteseDe") ? "C" : "E";

                    if (this.autoCritIndexes.densidadeInfo == -1) {
                        let critIndex = -1;

                        //verificar se já existe um critério de utilidade administrativa
                        for (let [i, crit] of this.df.criteria.list.entries()) {
                            if (crit.type.value == "CriterioJustificacaoDensidadeInfo") {
                                critIndex = i;

                                break;
                            }
                        }

                        //se não existir criar
                        if (critIndex == -1) {
                            critIndex = this.df.criteria.list.length;

                            this.addNewJustCrit(this.df.criteria.list);

                            this.df.criteria.list[critIndex].type = {
                                value: "CriterioJustificacaoDensidadeInfo",
                                label: "Densidade Informacional",
                                rel: 2
                            };
                        }
                        this.autoCritIndexes.densidadeInfo = critIndex;
                    }
                }
            }
            else if (rel.relType == "eComplementarDe") {
                if (this.checkIfExistsRelation("eSintetizadoPor")) {
                    this.showMsg("Não podem existir ao mesmo tempo as relações 'Sintetizado Por' e 'Complementar De'!");
                }
                else {
                    this.df.end = "C";

                    if (this.autoCritIndexes.complementaridadeInfo == -1) {
                        let critIndex = -1;

                        //verificar se já existe um critério de utilidade administrativa
                        for (let [i, crit] of this.df.criteria.list.entries()) {
                            if (crit.type.value == "CriterioJustificacaoComplementaridadeInfo") {
                                critIndex = i;

                                break;
                            }
                        }

                        //se não existir criar
                        if (critIndex == -1) {
                            critIndex = this.df.criteria.list.length;

                            this.addNewJustCrit(this.df.criteria.list);

                            this.df.criteria.list[critIndex].type = {
                                value: "CriterioJustificacaoComplementaridadeInfo",
                                label: "Critério Complementaridade Informacional",
                                rel: 2
                            };
                        }
                        this.autoCritIndexes.complementaridadeInfo = critIndex;
                    }
                }
            }
        },
        checkIfExistsRelation: function (rela, from) {
            if (from) {
                for (let rel of this.relationsSelected.slice(from)) {
                    if (rel.relType == rela) {
                        return true;
                    }
                }
            }
            else {
                for (let rel of this.relationsSelected) {
                    if (rel.relType == rela) {
                        return true;
                    }
                }
            }
            return false;
        },
        showMsg(text) {
            this.modalMsg = text;
            this.modalMsgShow = true;
        },
        loadCountTypes: function () {
            this.$http.get("/api/vocabulario/formasContagemPCA")
                .then(function (response) {
                    this.countTypes = response.body
                        .map(function (a) { return { label: a.label, id: a.id }});

                    this.countsReady = true;
                })
                .catch(function (error) { console.error(error);});
        },
        loadSubCountTypes: function () {
            this.$http.get("/api/vocabulario/subFormasContagemPCA")
                .then(function (response) {
                    this.subcountTypes = response.body.map(function (a) {
                            return { label: a.Label, id: a.id } });
                    this.subcountsReady = true;
                })
                .catch(function (error) { console.error(error); });
        },
        cleanSelection: function (path) {
            for (var line of path) {
                line.selected = false;
                line.drop = false;

                if (line.sublevel) {
                    this.cleanSelection(line.sublevel);
                }
            }
        },
        legSelectedCrit: function (row, obj) {
            if (!row.selected) {
                obj.leg.push({
                    id: row.id,
                    Num: row.data[2],
                    Type: row.data[1]
                });
            }
            else {
                let i = 0;
                for (let doc of obj.leg) {
                    if (row.id == doc.id) { break; }
                    i++;
                }
                if (i < obj.leg.length) {
                    obj.leg.splice(i, 1);
                }
            }
        },
        pnSelectedCrit: function (row, obj) {
            if (!row.selected) {
                obj.pns.push({
                    id: row.id,
                    Code: row.data[1],
                    Title: row.data[2]
                });
            }
            else {
                let i = 0;
                for (let p of obj.pns) {
                    if (row.id == p.id) { break; }
                    i++;
                }
                if (i < obj.pns.length) {
                    obj.pns.splice(i, 1);
                }
            }
        },
        critTypeSelected(crit, obj, payload) {
            crit.RelsReady = false;

            if (payload && payload.rel >= 2) {
                crit.pnsToSelect = JSON.parse(JSON.stringify(this[obj].criteria.pns[payload.value]));
            }

            crit.RelsReady = true;
        },
        addNewJustCrit: function (obj) {
            obj.push({
                RelsReady: false,
                type: { label: "Tipo de Critério", rel: 0 },
                content: null,
                pns: [],
                leg: [],
                legToSelect: JSON.parse(JSON.stringify(this.pca.criteria.legislation)),
                pnsToSelect: []
            });
        },
        loadClasses: function () {
            this.ready = false;
            let content = [];

            this.$http.get("/api/classes")
                .then(function (response) {
                    this.relationLists = response.body;
                    this.pca.criteria.classes = response.body;
                    this.df.criteria.classes = response.body;
                    this.classesReady = true;
                })
                .catch(function (error) {
                    console.error(error);
                });
        },
        selectClicked(payload) {
            alert(JSON.stringify(payload))
            var row = payload.rowData;

            if (!row.selected) {
                let newPN = {
                    selected: true,
                    titulo: row.titulo,
                    codigo: row.codigo,
                    id: 'c' + row.codigo,
                    relType: null
                };

                this.relationsSelected.push(newPN);

                this.relationsSelected.sort(
                    function (a, b) {
                        return a.codigo.localeCompare(b.code);
                    }
                );
            }

            else {
                let index = 0;
                let found = false;

                while(index < this.relationsSelected.length && !found){
                    if (this.relationsSelected[index].codigo == row.codigo) found=true;
                    index++;
                }
                    
                if (index < this.relationsSelected.length) {
                    this.relationsSelected.splice(index, 1);
                }
            }
        },
        loadEntidades: function () {
            var i = 0;

            this.$http.get("/api/entidades")
                .then(response => {
                    this.ownerList = response.body
                        .map(function (item) {
                            return {
                                data: [i++, item.sigla, item.designacao, "Entidade"],
                                selected: false,
                                id: item.id
                            }
                        });
                    this.$http.get("/api/tipologias")
                        .then(response => {
                            this.ownerList = this.ownerList.concat(
                                response.body
                                    .map(function (item) {
                                        return {
                                            data: [i++, item.sigla, item.designacao, "Tipologia"],
                                            selected: false,
                                            id: item.id
                                        }
                                    })
                            ).sort(function (a, b) {
                                return a.data[1].localeCompare(b.data[1]);
                            });

                            for (let type in this.participantLists) {
                                if (type != "Executor") {
                                    this.participantLists[type] = JSON.parse(
                                        JSON.stringify(this.ownerList)
                                    );
                                }
                            }

                            this.orgsReady = true;
                        })
                        .catch(function (error) {
                            console.error(error);
                        });
                })
                .catch(function (error) {
                    console.error(error);
                });
        },
        orgSelected: function (row, list, partType) {
            var findIndex = function (list, id) {
                for (let [index, item] of list.entries()) {
                    if (id == item.id) {
                        return index;
                    }
                }
                return -1;
            }

            if (!row.selected) {
                list.push(row.id);

                if (partType && partType != 'dono') {
                    this.participantsSelectedInfo[partType].push(row.data);
                }
                if (partType && partType == 'dono') {
                    this.participantLists.Executor.push(JSON.parse(JSON.stringify(row)));
                }
            }
            else {
                let index = list.indexOf(row.id);
                if (index != -1) {
                    list.splice(index, 1);

                    if (partType && partType != 'dono') {
                        this.participantsSelectedInfo[partType].splice(index, 1);
                    }
                    else if (partType && partType == 'dono') {
                        let exIndex = this.participantsSelected.Executor.indexOf(row.id);
                        if (exIndex != -1) {
                            this.participantsSelected.Executor.splice(exIndex, 1);
                            this.participantsSelectedInfo.Executor.splice(exIndex, 1);
                        }

                        let listIndex = findIndex(this.participantLists.Executor, row.id);
                        if (listIndex != -1) {
                            this.participantLists.Executor.splice(listIndex, 1);
                        }
                    }
                }
            }
        },
        loadLegs: function () {
            var i = 0;

            this.$http.get("/api/legislacao")
                .then(response => {
                    this.legList = response.body
                        .map(function (item) {
                            return {
                                data: [i++, item.tipo, item.numero, item.sumario, item.data],
                                selected: false,
                                id: item.id
                            }
                        });
                    this.pca.criteria.legislation = this.legList
                    this.df.criteria.legislation = this.legList
                    this.legsReady = true
                })
                .catch(function (error) {
                    console.error(error);
                });
        },
        loadParents: function () {
            this.$http.get("/api/classes/nivel/" + (this.classLevel - 1))
                .then(function (response) {
                    this.parents = response.body.map(function (item) {
                        return {
                            label: item.codigo + " - " + item.titulo,
                            value: item.id.split('#')[1],
                        }
                    }).sort(function (a, b) {
                        return a.label.localeCompare(b.label);
                    });
                    this.parentsReady = true;
                })
                .catch(function (error) {
                    console.error(error);
                });
        },
        parse: function (content, keys) {
            var dest = [];
            var temp = {};

            // parsing the JSON
            for (var i = 0; i < content.length; i++) {
                for (var j = 0; j < keys.length; j++) {
                    temp[keys[j]] = content[i][keys[j]].value;

                    if (keys[j] == "id") {
                        temp.id = temp.id.replace(/[^#]+#(.*)/, '$1');
                    }
                }

                dest[i] = JSON.parse(JSON.stringify(temp));
            }

            return dest;
        },
        addNewIndex: function () {
            if (this.newIndex) {
                this.indexes.push({
                    id: "",
                    Note: this.newIndex
                });
                this.newIndex = '';
            }
        },
        checkready: function (dataObj) {
            if (!this.code.match(/^([0-9]+\.)*[0-9]+$/)) {
                messageL.showMsg("Formato do código errado!");
                return false;
            }

            if (this.codeMessage.length > 0) {
                messageL.showMsg("Formato do código errado!");
                return false;
            }

            //verificar relações
            if (this.relationsSelected.length) {
                for ([i, pn] of this.relationsSelected.entries()) {
                    if (!pn.relType) {
                        messageL.showMsg("É necessário selecionar o tipo de relação com todos os processos relacionados selecionados!");
                        return false;
                    }
                    else if (pn.relType == "eSintetizadoPor") {
                        if (this.checkIfExistsRelation("eSinteseDe", i)) {
                            messageL.showMsg("Não podem existir ao mesmo tempo as relações 'Síntese De' e 'Sintetizado Por'!");
                            return false;
                        }
                        if (this.checkIfExistsRelation("eComplementarDe", i)) {
                            messageL.showMsg("Não podem existir ao mesmo tempo as relações 'Complementar De' e 'Sintetizado Por'!");
                            return false;
                        }
                    }
                }
            }

            if (this.classLevel == 1) {
                //verificar campos obrigatórios
                if (this.code && this.title) {
                    dataObj = {
                        Level: this.classLevel,               //
                        Parent: null,                   //
                        Code: this.code,                //
                        Title: this.title,              //
                        Description: this.description,  //
                        AppNotes: this.appNotes,        //
                        ExAppNotes: this.exAppNotes,    //
                        DelNotes: this.delNotes,        //
                        Type: null,                     //
                        Trans: null,                    //
                        Owners: null,                   //
                        Participants: null,             //
                        RelProcs: null,                 //
                        Status: this.status,            //
                        Legislations: null,             //
                        Indexes: null,
                        PCA: null,
                        DF: null,
                    };

                    return dataObj;
                }
                else {
                    messageL.showMsg("Preencher campos obrigatórios!");
                    return false;
                }
            }
            else {
                if (this.parent && this.code && this.title) {
                    if (this.classLevel >= 3) {
                        if (this.procTrans == 'S') {
                            let check = 0;

                            for (const key in this.participantsSelected) {
                                check += this.participantsSelected[key].length;
                            }

                            if (check == 0) {
                                messageL.showMsg("Um processo transversal tem de ter pelo menos um participante!");
                                return false;
                            }
                            else {
                                dataObj = {
                                    Level: this.classLevel,                       //
                                    Parent: this.parent,                    //
                                    Code: this.code,                        //
                                    Title: this.title,                      //
                                    Description: this.description,          //
                                    AppNotes: this.appNotes,                //
                                    ExAppNotes: this.exAppNotes,            //
                                    DelNotes: this.delNotes,                //
                                    Indexes: this.indexes,                  //
                                    Type: this.procType,                    //
                                    Trans: this.procTrans,                  //
                                    Owners: this.selectedOwners,            //
                                    Participants: this.participantsSelected,//
                                    RelProcs: this.relationsSelected,       //
                                    Status: this.status,                    //
                                    Legislations: this.selectedLegs,        //
                                    PCA: {
                                        dueDate: this.pca.dueDate,
                                        count: this.pca.count,
                                        subcount: this.pca.subcount,
                                        criteria: this.pca.criteria.list.map(
                                            function (crit) {
                                                return {
                                                    type: crit.type,
                                                    leg: crit.leg,
                                                    pns: crit.pns,
                                                    content: crit.content
                                                }
                                            }
                                        )
                                    },
                                    DF: {
                                        end: this.df.end,
                                        criteria: this.df.criteria.list.map(
                                            function (crit) {
                                                return {
                                                    type: crit.type,
                                                    leg: crit.leg,
                                                    pns: crit.pns,
                                                    content: crit.content
                                                }
                                            }
                                        )
                                    },
                                };

                                return dataObj;
                            }
                        }
                        else {
                            dataObj = {
                                Level: this.classLevel,                   //
                                Parent: this.parent,                //
                                Code: this.code,                    //
                                Title: this.title,                  //
                                Description: this.description,      //
                                AppNotes: this.appNotes,            //
                                ExAppNotes: this.exAppNotes,        //
                                DelNotes: this.delNotes,            //
                                Indexes: this.indexes,              //
                                Type: this.procType,                //
                                Trans: this.procTrans,              //
                                Owners: this.selectedOwners,        //
                                Participants: null,                 //
                                RelProcs: this.relationsSelected,   //
                                Status: this.status,                //
                                Legislations: this.selectedLegs,    //
                                PCA: {
                                    dueDate: this.pca.dueDate,
                                    count: this.pca.count,
                                    subcount: this.pca.subcount,
                                    criteria: this.pca.criteria.list.map(
                                        function (crit) {
                                            return {
                                                type: crit.type,
                                                leg: crit.leg,
                                                pns: crit.pns,
                                                content: crit.content
                                            }
                                        }
                                    )
                                },
                                DF: {
                                    end: this.df.end,
                                    criteria: this.df.criteria.list.map(
                                        function (crit) {
                                            return {
                                                type: crit.type,
                                                leg: crit.leg,
                                                pns: crit.pns,
                                                content: crit.content
                                            }
                                        }
                                    )
                                },
                            };

                            return dataObj;
                        }
                    }
                    else {
                        dataObj = {
                            Level: this.classLevel,               //
                            Parent: this.parent,            //
                            Code: this.code,                //
                            Title: this.title,              //
                            Description: this.description,  //
                            AppNotes: this.appNotes,        //
                            ExAppNotes: this.exAppNotes,    //
                            DelNotes: this.delNotes,        //
                            Indexes: null,                  //
                            Type: null,                     //
                            Trans: null,                    //
                            Owners: null,                   //
                            Participants: null,             //
                            RelProcs: null,                 //
                            Status: this.status,            //
                            Legislations: null,             //
                            PCA: null,
                            DF: null,
                        };

                        return dataObj;
                    }
                }
                else {
                    messageL.showMsg("Preencher campos obrigatórios!");
                    return false;
                }
            }
        },
        add: function () {
            this.$refs.spinner.show();

            for ([i, note] of this.appNotes.entries()) {
                note.id = "na_c" + this.code + "_" + (i + 1);
            }

            for ([i, note] of this.delNotes.entries()) {
                note.id = "ne_c" + this.code + "_" + (i + 1);
            }

            var dataObj = {
                Level: null,        //
                Parent: null,       //
                Code: null,         //
                Title: null,        //
                Description: null,  //
                AppNotes: null,     //
                ExAppNotes: null,   //
                DelNotes: null,     //
                Type: null,         //
                Trans: null,        //
                Owners: null,       //
                Participants: null, //
                RelProcs: null,     //
                Status: null,       //
                Legislations: null, //
                Indexes: null,
                PCA: null,
                DF: null
            };

            if (dataObj = this.checkready(dataObj)) {

                this.$http.post('/api/classes', dataObj, {
                    headers: {
                        'content-type': 'application/json'
                    }
                }).then(function (response) {
                    regex = new RegExp(/[0-9]+\-[0-9]+/, "gi");

                    if (regex.test(response.body)) {
                        window.location.href = '/users/pedido_submetido/' + response.body;
                    }
                    else {
                        messageL.showMsg(response.body);
                    }

                    this.$refs.spinner.hide();
                }).catch(function (error) {
                    console.error(error);
                    this.message = "Ocorreu um erro!"
                    this.$refs.spinner.hide();
                });

                //console.log(dataObj);
            }
            else {
                this.$refs.spinner.hide();
            }
        }
    },
    created: function () {
        this.loadEntidades();
        this.loadLegs();
        this.loadClasses();
        this.loadCountTypes();
        this.loadSubCountTypes();
    }
})